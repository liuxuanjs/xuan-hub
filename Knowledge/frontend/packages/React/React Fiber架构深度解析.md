# React Fiberï¼šè®©Reactåº”ç”¨ä¸æ»‘å¦‚å¾·èŠ™çš„é»‘ç§‘æŠ€

> ä½ æœ‰æ²¡æœ‰é‡åˆ°è¿‡è¿™æ ·çš„æƒ…å†µï¼šReactåº”ç”¨åœ¨å¤„ç†å¤§é‡æ•°æ®æ—¶å¡é¡¿ï¼Œç”¨æˆ·ç‚¹å‡»æŒ‰é’®åŠå¤©æ²¡ååº”ï¼Ÿæˆ–è€…è¾“å…¥æ¡†æ‰“å­—éƒ½æœ‰å»¶è¿Ÿï¼Ÿè¿™äº›é—®é¢˜çš„æ ¹æºï¼Œå¾ˆå¯èƒ½å°±æ˜¯å› ä¸ºä¸äº†è§£React Fiberçš„å·¥ä½œæœºåˆ¶ã€‚

## ä¸ºä»€ä¹ˆéœ€è¦Fiberï¼Ÿè€æ¶æ„å“ªé‡Œä¸å¤Ÿç”¨äº†

### ä¼ ç»ŸReactçš„"éœ¸é“æ€»è£"é—®é¢˜

åœ¨React 16ä¹‹å‰ï¼ŒReactä½¿ç”¨çš„æ˜¯**é€’å½’å¼çš„åè°ƒç®—æ³•**ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œè¿™å°±åƒä¸€ä¸ªéœ¸é“æ€»è£ï¼Œä¸€æ—¦å¼€å§‹å·¥ä½œå°±åœä¸ä¸‹æ¥ã€‚

```javascript
// è€ç‰ˆæœ¬Reactçš„å·¥ä½œæ–¹å¼ï¼ˆç®€åŒ–ç†è§£ï¼‰
function updateComponent(component) {
  // ä¸€å£æ°”å¤„ç†å®Œæ‰€æœ‰å­ç»„ä»¶ï¼Œä¸å…è®¸ä¸­æ–­
  component.children.forEach(child => {
    updateComponent(child); // é€’å½’è°ƒç”¨
  });
  component.render();
}
```

è¿™ç§æ–¹å¼æœ‰ä¸ªè‡´å‘½é—®é¢˜ï¼š**ä¸€æ—¦å¼€å§‹æ›´æ–°ï¼Œå°±å¿…é¡»ä¸€æ¬¡æ€§å¤„ç†å®Œæ•´ä¸ªç»„ä»¶æ ‘**ã€‚å¦‚æœä½ çš„åº”ç”¨æœ‰1000ä¸ªç»„ä»¶éœ€è¦æ›´æ–°ï¼Œæµè§ˆå™¨å°±ä¼šè¢«"éœ¸å "å¾ˆé•¿æ—¶é—´ï¼Œç”¨æˆ·çš„ç‚¹å‡»ã€è¾“å…¥éƒ½ä¼šè¢«å¿½ç•¥ã€‚

### ä¸¾ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­

è¿™å°±åƒä½ åœ¨é¤å…ç‚¹é¤ï¼Œå¨å¸ˆæ¥åˆ°è®¢å•åå¿…é¡»æŠŠä½ çš„èœåšå®Œæ‰èƒ½å¤„ç†ä¸‹ä¸€ä¸ªå®¢äººã€‚å¦‚æœä½ ç‚¹äº†æ»¡æ±‰å…¨å¸­ï¼Œåé¢çš„å®¢äººå°±å¾—é¥¿ç€ç­‰ã€‚

è€ŒFiberå°±åƒå¼•å…¥äº†"åˆ†æ—¶çƒ¹é¥ª"åˆ¶åº¦ï¼Œå¨å¸ˆå¯ä»¥åšä¸€ä¼šå„¿ä½ çš„èœï¼Œå†å»å¤„ç†å…¶ä»–å®¢äººçš„ç®€å•éœ€æ±‚ï¼Œç„¶åå›æ¥ç»§ç»­åšä½ çš„èœã€‚

## Fiberä¸ºä»€ä¹ˆèƒ½ä¸­æ–­ï¼Ÿæ­ç§˜åº•å±‚æœºåˆ¶

### å…³é”®é—®é¢˜ï¼šä¸ºä»€ä¹ˆè€Reactä¸èƒ½ä¸­æ–­ï¼Ÿ

è¦ç†è§£Fiberä¸ºä»€ä¹ˆèƒ½ä¸­æ–­ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æ˜ç™½è€Reactä¸ºä»€ä¹ˆä¸èƒ½ä¸­æ–­ï¼š

```javascript
// è€Reactçš„é€’å½’è°ƒç”¨ï¼ˆä¸èƒ½ä¸­æ–­çš„åŸå› ï¼‰
function updateComponentOld(component) {
  // é—®é¢˜ï¼šé€’å½’è°ƒç”¨ï¼Œåˆ©ç”¨çš„æ˜¯å‡½æ•°è°ƒç”¨æ ˆ
  component.children.forEach(child => {
    updateComponentOld(child); // ğŸ”¥ é€’å½’ï¼ä¸€æ—¦å¼€å§‹å°±åœä¸ä¸‹æ¥
  });
  
  // åªæœ‰æ‰€æœ‰å­ç»„ä»¶æ›´æ–°å®Œï¼Œè¿™é‡Œæ‰èƒ½æ‰§è¡Œ
  component.render();
  component.commitUpdate();
}
```

**ä¸ºä»€ä¹ˆé€’å½’ä¸èƒ½ä¸­æ–­ï¼Ÿ** å› ä¸ºJavaScriptçš„å‡½æ•°è°ƒç”¨æ ˆæ˜¯è¿ç»­çš„ï¼å½“ä½ è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œå¿…é¡»ç­‰å®ƒæ‰§è¡Œå®Œæ‰èƒ½è¿”å›ã€‚è¿™å°±åƒä½ åœ¨ç”µæ¢¯é‡Œï¼Œå¿…é¡»ç­‰ç”µæ¢¯åˆ°äº†ç›®æ ‡æ¥¼å±‚æ‰èƒ½å‡ºæ¥ã€‚

### Fiberçš„æ ¸å¿ƒåˆ›æ–°ï¼šæŠŠé€’å½’æ”¹æˆå¾ªç¯

Fiberçš„å¤©æ‰ä¹‹å¤„åœ¨äºï¼š**æŠŠé€’å½’è°ƒç”¨æ ˆæ”¹æˆäº†å¯æ§åˆ¶çš„æ•°æ®ç»“æ„**ï¼

```javascript
// Fiberçš„æ ¸å¿ƒï¼šç”¨é“¾è¡¨æ›¿ä»£è°ƒç”¨æ ˆ
function workLoopConcurrent() {
  // ğŸ¯ å…³é”®ï¼šè¿™æ˜¯ä¸ªwhileå¾ªç¯ï¼Œä¸æ˜¯é€’å½’ï¼
  while (workInProgress !== null && !shouldYieldToHost()) {
    workInProgress = performUnitOfWork(workInProgress);
  }
  
  // å¦‚æœæ—¶é—´ç‰‡ç”¨å®Œäº†ï¼ŒworkInProgressè¿˜æœ‰å€¼
  // è¯´æ˜å·¥ä½œæ²¡åšå®Œï¼Œä½†æˆ‘ä»¬å¯ä»¥å…ˆåœä¸‹æ¥
  if (workInProgress !== null) {
    // ğŸ“… å…³é”®ï¼šæŠŠå‰©ä½™å·¥ä½œå®‰æ’åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡
    return RemainingWorkScheduled;
  }
}

function performUnitOfWork(unitOfWork) {
  // å¤„ç†å½“å‰èŠ‚ç‚¹
  const next = beginWork(unitOfWork);
  
  if (next === null) {
    // æ²¡æœ‰å­èŠ‚ç‚¹äº†ï¼Œå¼€å§‹å¤„ç†å…„å¼ŸèŠ‚ç‚¹
    completeUnitOfWork(unitOfWork);
  }
  
  return next; // è¿”å›ä¸‹ä¸€ä¸ªè¦å¤„ç†çš„èŠ‚ç‚¹
}
```

### ç”¨ç”Ÿæ´»ä¾‹å­ç†è§£ï¼šä»"é€’å½’ç”µæ¢¯"åˆ°"å¯ä¸­æ–­åœ°é“"

**è€Reactåƒç”µæ¢¯ï¼š**
- è¿›å…¥ç”µæ¢¯åå¿…é¡»ç­‰åˆ°ç›®æ ‡æ¥¼å±‚æ‰èƒ½å‡ºæ¥
- ä¸­é€”ä¸èƒ½åœä¸‹æ¥åšåˆ«çš„äº‹
- å¦‚æœè¦åˆ°100æ¥¼ï¼Œå¿…é¡»ä¸€å£æ°”åˆ°åº•

**Fiberåƒåœ°é“ï¼š**
- æ¯ä¸€ç«™éƒ½å¯ä»¥ä¸‹è½¦ï¼ˆæ£€æŸ¥æ—¶é—´ç‰‡ï¼‰
- å¦‚æœæœ‰ç´§æ€¥äº‹æƒ…ï¼Œå¯ä»¥å…ˆä¸‹è½¦å¤„ç†
- å¤„ç†å®Œåå†ä»å½“å‰ç«™ç»§ç»­ååˆ°ç›®æ ‡ç«™

### FiberèŠ‚ç‚¹ï¼šæ¯ä¸ªç»„ä»¶çš„"èº«ä»½è¯"

Fiberçš„æ ¸å¿ƒæ˜¯ä¸ºæ¯ä¸ªReactå…ƒç´ åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„FiberèŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹åŒ…å«äº†æ”¯æŒä¸­æ–­å’Œæ¢å¤çš„å…³é”®ä¿¡æ¯ï¼š

```javascript
const FiberNode = {
  // ç»„ä»¶åŸºæœ¬ä¿¡æ¯
  type: 'div',
  props: { className: 'container' },
  
  // ğŸ”— é“¾è¡¨æŒ‡é’ˆï¼šæ›¿ä»£é€’å½’è°ƒç”¨æ ˆçš„å…³é”®
  child: null,    // ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹
  sibling: null,  // å…„å¼ŸèŠ‚ç‚¹  
  return: null,   // çˆ¶èŠ‚ç‚¹
  
  // ğŸ• å·¥ä½œçŠ¶æ€ï¼šæ”¯æŒä¸­æ–­æ¢å¤
  alternate: null,        // åŒç¼“å­˜æœºåˆ¶
  effectTag: 'UPDATE',    // æ“ä½œç±»å‹
};
```

è¿™å°±æ˜¯Fiberèƒ½å¤Ÿä¸­æ–­çš„æ ¸å¿ƒç§˜å¯†ï¼š**ç”¨å¯æ§åˆ¶çš„æ•°æ®ç»“æ„ï¼ˆé“¾è¡¨ï¼‰æ›¿ä»£äº†ä¸å¯æ§åˆ¶çš„ç¨‹åºç»“æ„ï¼ˆé€’å½’è°ƒç”¨æ ˆï¼‰**ï¼

## Fiberå¦‚ä½•æ¢å¤ï¼Ÿä¸­æ–­åçš„"æ–­ç‚¹ç»­ä¼ "

ç†è§£äº†ä¸­æ–­æœºåˆ¶ï¼Œæ›´å…³é”®çš„æ˜¯æ¢å¤æœºåˆ¶ã€‚Fiberå¦‚ä½•åšåˆ°"æ–­ç‚¹ç»­ä¼ "ï¼Ÿ

### æ¢å¤çš„æ ¸å¿ƒï¼šå·¥ä½œè¿›åº¦æŒä¹…åŒ–

```javascript
// å…¨å±€å˜é‡ä¿å­˜å·¥ä½œçŠ¶æ€ï¼šè¿™æ˜¯æ¢å¤çš„å…³é”®
let workInProgress = null;    // ğŸ‘ˆ å½“å‰å¤„ç†çš„èŠ‚ç‚¹æŒ‡é’ˆ
let workInProgressRoot = null; // å·¥ä½œæ ¹èŠ‚ç‚¹

function workLoopConcurrent() {
  // ğŸ”„ ä»ä¸Šæ¬¡ä¸­æ–­çš„åœ°æ–¹ç»§ç»­
  while (workInProgress !== null && !shouldYieldToHost()) {
    workInProgress = performUnitOfWork(workInProgress);
  }
  
  // å¦‚æœè¿˜æœ‰å·¥ä½œæœªå®Œæˆï¼Œå®‰æ’ä¸‹æ¬¡ç»§ç»­
  if (workInProgress !== null) {
    scheduleCallback(workLoopConcurrent);
  }
}
```

### åŒç¼“å­˜æœºåˆ¶ï¼šä¿è¯æ¢å¤æ—¶çš„ä¸€è‡´æ€§

æ¢å¤æœºåˆ¶çš„å¦ä¸€ä¸ªå…³é”®æ˜¯**åŒç¼“å­˜**ï¼Œç¡®ä¿ä¸­æ–­æœŸé—´é¡µé¢ä¾ç„¶æ­£å¸¸æ˜¾ç¤ºï¼š

```javascript
// åŒç¼“å­˜ï¼šä¸¤æ£µFiberæ ‘
const current = {        // å½“å‰å±å¹•æ˜¾ç¤ºçš„æ ‘
  type: 'App',
  child: headerFiber,
  // ...
};

const workInProgress = { // æ­£åœ¨æ„å»ºçš„æ–°æ ‘
  type: 'App', 
  child: newHeaderFiber,
  alternate: current,    // æŒ‡å‘æ—§æ ‘
  // ...
};

// ä¸­æ–­æ—¶ï¼šcurrentæ ‘ä¿è¯é¡µé¢æ­£å¸¸
// æ¢å¤æ—¶ï¼šç»§ç»­æ„å»ºworkInProgressæ ‘
// å®Œæˆæ—¶ï¼šä¸€æ¬¡æ€§åˆ‡æ¢æ ‘
```

è¿™æ ·ï¼ŒFiberå°±å®ç°äº†å®Œæ•´çš„ä¸­æ–­-æ¢å¤æœºåˆ¶ï¼š
1. **ä¸­æ–­**ï¼šé€šè¿‡å¾ªç¯+æ—¶é—´ç‰‡æ£€æŸ¥å®ç°å¯æ§ä¸­æ–­
2. **æ¢å¤**ï¼šé€šè¿‡å…¨å±€çŠ¶æ€ä¿å­˜å®ç°æ–­ç‚¹ç»­ä¼   
3. **ä¸€è‡´æ€§**ï¼šé€šè¿‡åŒç¼“å­˜ä¿è¯é¡µé¢ç¨³å®š

## é€šè¿‡ä»£ç çœ‹Fiberå¦‚ä½•å·¥ä½œ

### Fiberè°ƒåº¦çš„å®é™…ä½“éªŒ

```jsx
import React, { useState, useTransition } from 'react';

function SmartApp() {
  const [count, setCount] = useState(0);
  const [list, setList] = useState([]);
  const [isPending, startTransition] = useTransition();

  const generateHeavyList = () => {
    startTransition(() => {
      // ä½ä¼˜å…ˆçº§ï¼šå¤§é‡æ•°æ®æ¸²æŸ“
      const newList = Array.from({length: 10000}, (_, i) => ({
        id: i, label: `Item ${i}`
      }));
      setList(newList);
    });
  };

  return (
    <div>
      {/* é«˜ä¼˜å…ˆçº§ï¼šç”¨æˆ·äº¤äº’ç«‹å³å“åº” */}
      <button onClick={() => setCount(count + 1)}>
        ç‚¹å‡»æ¬¡æ•°: {count}
      </button>
      
      <button onClick={generateHeavyList}>
        {isPending ? 'æ¸²æŸ“ä¸­...' : 'ç”Ÿæˆå¤§åˆ—è¡¨'}
      </button>
      
      {/* å³ä½¿æ¸²æŸ“10000ä¸ªé¡¹ç›®ï¼Œç‚¹å‡»æŒ‰é’®ä¾ç„¶ä¸æ»‘ */}
      <div>
        {list.map(item => <div key={item.id}>{item.label}</div>)}
      </div>
    </div>
  );
}
```

è¿™å°±æ˜¯Fiberçš„é­…åŠ›ï¼š**ç”¨æˆ·äº¤äº’æ°¸è¿œæ˜¯ç¬¬ä¸€ä¼˜å…ˆçº§ï¼Œå¤§æ•°æ®æ¸²æŸ“å¯ä»¥"è®©è·¯"**ï¼

## å®é™…é¡¹ç›®ä¸­å¦‚ä½•åˆ©ç”¨Fiberç‰¹æ€§

### æ™ºèƒ½æœç´¢ï¼šè¾“å…¥æµç•…ï¼Œæœç´¢ä¸å¡

```jsx
import { useDeferredValue, startTransition } from 'react';

function SmartSearch() {
  const [query, setQuery] = useState('');
  const [results, setResults] = useState([]);
  const deferredQuery = useDeferredValue(query);
  
  const handleSearch = (value) => {
    setQuery(value);  // ğŸš€ ç«‹å³æ›´æ–°è¾“å…¥æ¡†
    
    startTransition(() => {
      // ğŸŒ å»¶è¿Ÿæ›´æ–°æœç´¢ç»“æœï¼Œä¸å½±å“è¾“å…¥ä½“éªŒ
      const newResults = expensiveSearch(value);
      setResults(newResults);
    });
  };

  return (
    <div>
      <input 
        value={query}
        onChange={(e) => handleSearch(e.target.value)}
        placeholder="è¾“å…¥ä¾ç„¶ä¸æ»‘..."
      />
      <SearchResults query={deferredQuery} results={results} />
    </div>
  );
}
```

### æ¸è¿›å¼åŠ è½½ï¼šç”¨æˆ·ä¸ç­‰å¾…

```jsx
import { Suspense, lazy } from 'react';

const HeavyChart = lazy(() => import('./HeavyChart'));

function Dashboard() {
  return (
    <div>
      <h1>ç«‹å³æ˜¾ç¤ºçš„æ ‡é¢˜</h1>
      
      <Suspense fallback={<div>å›¾è¡¨åŠ è½½ä¸­...</div>}>
        <HeavyChart />
      </Suspense>
    </div>
  );
}
```

## å¸¸è§è¸©å‘ä¸æœ€ä½³å®è·µ

### âŒ æ»¥ç”¨startTransition
```jsx
// é”™è¯¯ï¼šè¿è¾“å…¥æ¡†éƒ½å»¶è¿Ÿæ›´æ–°
startTransition(() => {
  setInput(e.target.value); // ç”¨æˆ·ä¼šæ„Ÿè§‰å»¶è¿Ÿï¼
});

// æ­£ç¡®ï¼šåªå»¶è¿Ÿéç´§æ€¥æ›´æ–°
setInput(value);           // ç«‹å³æ›´æ–°
startTransition(() => {
  setResults(search(value)); // å»¶è¿Ÿæ›´æ–°
});
```

### âŒ renderå‡½æ•°ä¸çº¯å‡€
```jsx
// é”™è¯¯ï¼šrenderä¸­æœ‰å‰¯ä½œç”¨
function BadComponent() {
  console.log('render'); // å¯èƒ½ä¼šçœ‹åˆ°å¤šæ¬¡è¾“å‡º
  localStorage.setItem('key', 'value'); // å‰¯ä½œç”¨ï¼
  return <div>Hello</div>;
}

// æ­£ç¡®ï¼šå‰¯ä½œç”¨æ”¾åœ¨useEffect
function GoodComponent() {
  useEffect(() => {
    localStorage.setItem('key', 'value');
  }, []);
  return <div>Hello</div>;
}
```

## æ€»ç»“ï¼šFiberçš„æ ¸å¿ƒä»·å€¼

React Fiberç”¨ä¸€ä¸ªå·§å¦™çš„æ¶æ„åˆ›æ–°è§£å†³äº†å‰ç«¯æ€§èƒ½çš„æ ¹æœ¬é—®é¢˜ï¼š

### ğŸ¯ æ ¸å¿ƒçªç ´
- **ä¸­æ–­æœºåˆ¶**ï¼šå¾ªç¯+é“¾è¡¨æ›¿ä»£é€’å½’è°ƒç”¨æ ˆ
- **æ¢å¤æœºåˆ¶**ï¼šå…¨å±€çŠ¶æ€+åŒç¼“å­˜å®ç°æ–­ç‚¹ç»­ä¼   
- **ä¼˜å…ˆçº§è°ƒåº¦**ï¼šç”¨æˆ·äº¤äº’æ°¸è¿œç¬¬ä¸€ä¼˜å…ˆçº§

### ğŸ’¡ å®ç”¨ä»·å€¼
- **ç”¨æˆ·ä½“éªŒ**ï¼šå†å¤æ‚çš„æ¸²æŸ“ä¹Ÿä¸ä¼šé˜»å¡ç”¨æˆ·æ“ä½œ
- **å¼€å‘æ•ˆç‡**ï¼šé€šè¿‡`startTransition`ç­‰APIè½»æ¾ä¼˜åŒ–æ€§èƒ½
- **æœªæ¥å…¼å®¹**ï¼šä¸ºReactçš„å¹¶å‘ç‰¹æ€§å¥ å®šåŸºç¡€

### ğŸ“‹ è®°ä½è¿™äº›è¦ç‚¹
- âœ… ç”¨æˆ·äº¤äº’ç«‹å³å“åº”ï¼ˆåŒæ­¥æ›´æ–°ï¼‰
- âœ… å¤§æ•°æ®æ¸²æŸ“ä½¿ç”¨`startTransition`ï¼ˆå¼‚æ­¥æ›´æ–°ï¼‰  
- âœ… æœç´¢åœºæ™¯é…åˆ`useDeferredValue`
- âŒ ä¸è¦åœ¨renderä¸­æ‰§è¡Œå‰¯ä½œç”¨

æŒæ¡äº†Fiberï¼Œä½ å°±æ‹¥æœ‰äº†è®©Reactåº”ç”¨ä¸æ»‘å¦‚å¾·èŠ™çš„è¶…èƒ½åŠ›ï¼
