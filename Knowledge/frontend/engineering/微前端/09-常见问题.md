# 微前端常见问题 FAQ

本文总结了微前端实施过程中的常见问题和解决方案，帮助开发者快速定位和解决问题。

## 技术问题

### Q1: 子应用无法正常加载

**问题描述**：子应用注册后无法正常加载或显示空白页面

**可能原因**：
1. CORS 跨域问题
2. 子应用入口文件配置错误
3. 容器元素未找到
4. webpack 配置问题

**解决方案**：

```javascript
// 1. 检查 CORS 配置
// 子应用 webpack.config.js
module.exports = {
  devServer: {
    headers: {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, PATCH, OPTIONS',
      'Access-Control-Allow-Headers': 'X-Requested-With, content-type, Authorization',
    },
  },
};

// 2. 检查入口文件配置
// 确保 UMD 格式正确
module.exports = {
  output: {
    library: `${name}-[name]`,
    libraryTarget: 'umd',
    jsonpFunction: `webpackJsonp_${name}`,
  },
};

// 3. 检查容器元素
// 确保容器元素存在
const container = document.querySelector('#micro-app-container');
if (!container) {
  console.error('容器元素未找到');
}
```

### Q2: 样式冲突问题

**问题描述**：不同子应用之间出现样式相互影响

**解决方案**：

```javascript
// 1. 开启严格样式隔离
start({
  sandbox: {
    strictStyleIsolation: true,
    experimentalStyleIsolation: true,
  },
});

// 2. 使用 CSS Modules
// Button.module.css
.button {
  background-color: blue;
}

// 3. 添加命名空间
.app-react {
  .header {
    background-color: blue;
  }
}
```

### Q3: 应用间通信不工作

**问题描述**：事件总线或共享状态无法正常工作

**解决方案**：

```javascript
// 1. 检查事件总线是否正确初始化
if (!window.microEventBus) {
  console.error('事件总线未初始化');
}

// 2. 确保事件监听在正确的时机注册
export async function mount(props) {
  // 在 mount 阶段注册事件监听
  window.microEventBus.on('user:update', handleUserUpdate);
  render(props);
}

export async function unmount(props) {
  // 在 unmount 阶段清理事件监听
  window.microEventBus.off('user:update', handleUserUpdate);
}

// 3. 检查事件名称是否一致
const EVENT_TYPES = {
  USER_LOGIN: 'user:login',
  USER_LOGOUT: 'user:logout',
};
```

## 性能问题

### Q4: 应用加载速度慢

**问题描述**：子应用加载时间过长，影响用户体验

**解决方案**：

```javascript
// 1. 启用预加载
start({
  prefetch: 'all', // 或者 true
});

// 2. 手动预加载关键应用
import { prefetchApps } from 'qiankun';

prefetchApps([
  { name: 'critical-app', entry: '//localhost:3001' },
]);

// 3. 资源压缩和分割
// webpack.config.js
module.exports = {
  optimization: {
    splitChunks: {
      chunks: 'all',
      cacheGroups: {
        vendor: {
          test: /[\\/]node_modules[\\/]/,
          name: 'vendors',
          chunks: 'all',
        },
      },
    },
  },
};
```

### Q5: 内存泄漏问题

**问题描述**：频繁切换应用导致内存占用持续增长

**解决方案**：

```javascript
// 1. 正确清理事件监听器
export async function unmount(props) {
  // 清理事件监听
  window.removeEventListener('resize', handleResize);
  window.microEventBus.off('user:update', handleUserUpdate);
  
  // 清理定时器
  if (this.timerId) {
    clearInterval(this.timerId);
  }
  
  // 清理组件
  ReactDOM.unmountComponentAtNode(container);
}

// 2. 使用 WeakMap 避免内存泄漏
const componentCache = new WeakMap();

// 3. 定期清理缓存
setInterval(() => {
  if (window.gc) {
    window.gc();
  }
}, 60000);
```

## 开发问题

### Q6: 开发环境调试困难

**问题描述**：微前端环境下调试和开发体验差

**解决方案**：

```javascript
// 1. 创建调试面板
class MicroAppDebugger {
  constructor() {
    if (process.env.NODE_ENV === 'development') {
      this.createDebugPanel();
    }
  }
  
  createDebugPanel() {
    // 创建调试界面
  }
}

// 2. 增加详细日志
const logger = {
  info: (message, data) => {
    if (process.env.NODE_ENV === 'development') {
      console.log(`[MicroApp] ${message}`, data);
    }
  },
  error: (message, error) => {
    console.error(`[MicroApp Error] ${message}`, error);
  },
};

// 3. 热重载支持
// webpack.config.js
module.exports = {
  devServer: {
    hot: true,
    liveReload: true,
  },
};
```

### Q7: TypeScript 类型支持

**问题描述**：微前端环境下 TypeScript 类型检查和提示不完整

**解决方案**：

```typescript
// 1. 定义全局类型
// global.d.ts
declare global {
  interface Window {
    __POWERED_BY_QIANKUN__?: boolean;
    microEventBus: EventBus;
    sharedStore: Store;
  }
}

// 2. 定义微应用类型
interface MicroApp {
  name: string;
  entry: string;
  container: string;
  activeRule: string;
  props?: Record<string, any>;
}

// 3. 生命周期类型
interface LifeCycleFn {
  bootstrap?: (props?: any) => Promise<any>;
  mount?: (props?: any) => Promise<any>;
  unmount?: (props?: any) => Promise<any>;
  update?: (props?: any) => Promise<any>;
}
```

## 部署问题

### Q8: 生产环境部署失败

**问题描述**：本地开发正常，生产环境部署后无法正常工作

**解决方案**：

```javascript
// 1. 检查环境配置
const getAppEntry = (appName) => {
  const baseUrl = process.env.MICRO_APP_BASE_URL;
  return `${baseUrl}/${appName}/`;
};

// 2. 确保资源路径正确
// webpack.config.js
module.exports = {
  output: {
    publicPath: process.env.NODE_ENV === 'production' 
      ? 'https://cdn.example.com/app-name/' 
      : '/',
  },
};

// 3. 检查 CSP 策略
// 确保 CSP 允许动态脚本加载
<meta http-equiv="Content-Security-Policy" 
      content="script-src 'self' 'unsafe-eval' https://cdn.example.com;" />
```

### Q9: CDN 资源加载问题

**问题描述**：CDN 上的资源无法正常加载

**解决方案**：

```javascript
// 1. 配置正确的 publicPath
// webpack.config.js
module.exports = {
  output: {
    publicPath: 'https://cdn.example.com/micro-apps/',
  },
};

// 2. 处理相对路径问题
// 动态设置 publicPath
if (window.__POWERED_BY_QIANKUN__) {
  __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;
}

// 3. 资源加载重试机制
const loadResourceWithRetry = async (url, retries = 3) => {
  for (let i = 0; i < retries; i++) {
    try {
      return await fetch(url);
    } catch (error) {
      if (i === retries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
};
```

## 团队协作问题

### Q10: 版本兼容性问题

**问题描述**：不同团队开发的应用版本不兼容

**解决方案**：

```javascript
// 1. 建立版本管理规范
const versionManager = {
  checkCompatibility: (appName, version) => {
    const compatibilityMatrix = {
      'main-app': {
        'react-app': ['1.0.x', '1.1.x'],
        'vue-app': ['2.0.x'],
      },
    };
    
    return compatibilityMatrix['main-app'][appName]?.includes(version);
  },
};

// 2. API 版本控制
const apiVersions = {
  v1: '/api/v1',
  v2: '/api/v2',
};

// 3. 渐进式升级策略
const upgradeStrategy = {
  phases: [
    { apps: ['app-a'], version: '2.0.0', timeline: '2 weeks' },
    { apps: ['app-b'], version: '2.0.0', timeline: '4 weeks' },
  ],
};
```

## 故障排查清单

### 应用加载失败排查

```javascript
// 故障排查清单
const troubleshootingChecklist = {
  appLoadFailure: [
    '检查网络连接和 CORS 设置',
    '验证应用入口 URL 是否正确',
    '确认容器元素是否存在',
    '检查 webpack 配置是否正确',
    '查看浏览器控制台错误信息',
    '验证应用生命周期函数是否导出',
  ],
  
  communicationIssues: [
    '确认事件总线是否正确初始化',
    '检查事件名称是否一致',
    '验证事件监听器是否正确注册和清理',
    '查看事件是否被正确触发',
  ],
  
  performanceIssues: [
    '检查是否启用了预加载',
    '分析 bundle 大小和加载时间',
    '确认资源是否正确缓存',
    '检查内存使用情况',
    '验证代码分割是否生效',
  ],
};
```

### 调试工具

```javascript
// 微前端调试工具
class MicroFrontendDebugger {
  static diagnose() {
    const report = {
      environment: this.checkEnvironment(),
      applications: this.checkApplications(),
      communication: this.checkCommunication(),
      performance: this.checkPerformance(),
    };
    
    console.table(report);
    return report;
  }
  
  static checkEnvironment() {
    return {
      userAgent: navigator.userAgent,
      qiankunVersion: window.__QIANKUN_VERSION__,
      nodeEnv: process.env.NODE_ENV,
    };
  }
  
  static checkApplications() {
    // 检查已注册的应用
    return window.qiankunApps || [];
  }
  
  static checkCommunication() {
    return {
      eventBus: !!window.microEventBus,
      sharedStore: !!window.sharedStore,
    };
  }
  
  static checkPerformance() {
    const performance = window.performance;
    return {
      loadTime: performance.timing.loadEventEnd - performance.timing.navigationStart,
      domReady: performance.timing.domContentLoadedEventEnd - performance.timing.navigationStart,
    };
  }
}

// 使用调试工具
if (process.env.NODE_ENV === 'development') {
  window.microDebugger = MicroFrontendDebugger;
  console.log('微前端调试工具已加载，使用 window.microDebugger.diagnose() 进行诊断');
}
```

## 总结

微前端的问题排查需要从多个维度进行：

1. **技术层面**：检查配置、依赖、兼容性
2. **性能层面**：分析加载时间、内存使用、资源优化
3. **开发层面**：完善调试工具、日志记录、错误处理
4. **部署层面**：验证环境配置、资源路径、网络连接
5. **团队层面**：建立规范、版本管理、沟通机制

建议在项目中建立完善的监控和调试体系，定期进行健康检查，及时发现和解决问题。

---

**相关文档**：
- [技术实现方案](./02-技术实现方案.md)
- [监控与调试](./07-监控与调试.md)
- [最佳实践](./08-最佳实践.md)
