# å¾®å‰ç«¯æ€§èƒ½ä¼˜åŒ–

å¾®å‰ç«¯æ¶æ„çš„æ€§èƒ½ä¼˜åŒ–æ˜¯ç¡®ä¿ç”¨æˆ·ä½“éªŒçš„å…³é”®ç¯èŠ‚ã€‚æœ¬æ–‡ä»‹ç»å„ç§æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å’Œå®ç°æ–¹æ¡ˆã€‚

## é¢„åŠ è½½ç­–ç•¥

### qiankun é¢„åŠ è½½

```javascript
// é¢„åŠ è½½é…ç½®
start({
  prefetch: 'all', // é¢„åŠ è½½æ‰€æœ‰å­åº”ç”¨
  // æˆ–è€…è‡ªå®šä¹‰é¢„åŠ è½½ç­–ç•¥
  prefetch: (apps) => {
    const criticalApps = ['react-app', 'vue-app'];
    return apps.filter(app => criticalApps.includes(app.name));
  },
});

// æ‰‹åŠ¨é¢„åŠ è½½
import { prefetchApps } from 'qiankun';

// åœ¨åˆé€‚çš„æ—¶æœºé¢„åŠ è½½
prefetchApps([
  { name: 'react-app', entry: '//localhost:3001' },
  { name: 'vue-app', entry: '//localhost:3002' },
]);
```

### single-spa é¢„åŠ è½½

single-spa æœ¬èº«æ²¡æœ‰å†…ç½®é¢„åŠ è½½åŠŸèƒ½ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„é¢„åŠ è½½å®ç°ï¼š

```javascript
import { registerApplication, start } from 'single-spa';

// é¢„åŠ è½½ç®¡ç†å™¨
const AppPreloader = {
  cache: {}, // å­˜å‚¨é¢„åŠ è½½çš„åº”ç”¨
  
  // é¢„åŠ è½½åº”ç”¨
  async preload(name, loader) {
    // å¦‚æœå·²ç»é¢„åŠ è½½è¿‡ï¼Œç›´æ¥è¿”å›
    if (this.cache[name]) {
      return this.cache[name];
    }
    
    console.log(`ğŸš€ å¼€å§‹é¢„åŠ è½½: ${name}`);
    try {
      this.cache[name] = await loader();
      console.log(`âœ… é¢„åŠ è½½å®Œæˆ: ${name}`);
      return this.cache[name];
    } catch (error) {
      console.error(`âŒ é¢„åŠ è½½å¤±è´¥: ${name}`, error);
      throw error;
    }
  },
  
  // è·å–é¢„åŠ è½½çš„åº”ç”¨
  get(name) {
    return this.cache[name];
  },
  
  // æ£€æŸ¥æ˜¯å¦åº”è¯¥é¢„åŠ è½½ï¼ˆé¿å…æ…¢ç½‘ç»œå½±å“ç”¨æˆ·ï¼‰
  shouldPreload() {
    if (navigator.connection) {
      const effectiveType = navigator.connection.effectiveType;
      // 2G ç½‘ç»œä¸é¢„åŠ è½½
      if (effectiveType === 'slow-2g' || effectiveType === '2g') {
        return false;
      }
    }
    return true;
  },
  
  // è‡ªåŠ¨é¢„åŠ è½½
  autoPreload() {
    if (!this.shouldPreload()) {
      console.log('ğŸŒ ç½‘ç»œè¾ƒæ…¢ï¼Œè·³è¿‡é¢„åŠ è½½');
      return;
    }
    
    // é¡µé¢åŠ è½½å®Œ1ç§’åå¼€å§‹é¢„åŠ è½½ï¼Œé¿å…å½±å“é¦–å±æ€§èƒ½
    setTimeout(() => {
      this.preload('react-app', () => System.import('react-app'));
      this.preload('vue-app', () => System.import('vue-app'));
    }, 1000);
  }
};

// æ³¨å†Œåº”ç”¨ï¼ˆæ”¯æŒé¢„åŠ è½½ï¼‰
registerApplication({
  name: 'react-app',
  app: () => {
    // å…ˆæ£€æŸ¥æ˜¯å¦å·²é¢„åŠ è½½
    const cached = AppPreloader.get('react-app');
    if (cached) {
      console.log('ğŸ“¦ ä½¿ç”¨é¢„åŠ è½½çš„ React åº”ç”¨');
      return Promise.resolve(cached);
    }
    // æ²¡æœ‰é¢„åŠ è½½å°±æ­£å¸¸åŠ è½½
    return System.import('react-app');
  },
  activeWhen: '/react',
});

registerApplication({
  name: 'vue-app',
  app: () => {
    const cached = AppPreloader.get('vue-app');
    if (cached) {
      console.log('ğŸ“¦ ä½¿ç”¨é¢„åŠ è½½çš„ Vue åº”ç”¨');
      return Promise.resolve(cached);
    }
    return System.import('vue-app');
  },
  activeWhen: '/vue',
});

// å¯åŠ¨ single-spa
start();

// é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹é¢„åŠ è½½
window.addEventListener('load', () => {
  AppPreloader.autoPreload();
});

// å¯é€‰ï¼šé¼ æ ‡æ‚¬åœæ—¶ä¹Ÿè§¦å‘é¢„åŠ è½½
document.addEventListener('DOMContentLoaded', () => {
  // ç»™å¯¼èˆªé“¾æ¥æ·»åŠ æ‚¬åœé¢„åŠ è½½
  const reactLink = document.querySelector('a[href*="/react"]');
  const vueLink = document.querySelector('a[href*="/vue"]');
  
  if (reactLink) {
    reactLink.addEventListener('mouseenter', () => {
      AppPreloader.preload('react-app', () => System.import('react-app'));
    }, { once: true }); // åªè§¦å‘ä¸€æ¬¡
  }
  
  if (vueLink) {
    vueLink.addEventListener('mouseenter', () => {
      AppPreloader.preload('vue-app', () => System.import('vue-app'));
    }, { once: true });
  }
});
```

**ä½¿ç”¨ç¤ºä¾‹ï¼ˆå®Œæ•´çš„ HTML é¡µé¢ï¼‰ï¼š**

```html
<!DOCTYPE html>
<html>
<head>
  <title>Single-spa é¢„åŠ è½½ç¤ºä¾‹</title>
  <script src="https://cdn.jsdelivr.net/npm/systemjs@6/dist/system.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/single-spa@5/lib/system/single-spa.min.js"></script>
</head>
<body>
  <nav>
    <a href="/react">React åº”ç”¨</a>
    <a href="/vue">Vue åº”ç”¨</a>
  </nav>
  
  <div id="single-spa-application:react-app"></div>
  <div id="single-spa-application:vue-app"></div>

  <script type="systemjs-importmap">
    {
      "imports": {
        "react-app": "http://localhost:3001/main.js",
        "vue-app": "http://localhost:3002/main.js"
      }
    }
  </script>

  <script>
    // è¿™é‡Œæ”¾ä¸Šé¢çš„ AppPreloader å’Œæ³¨å†Œä»£ç 
  </script>
</body>
</html>
```

**æ ¸å¿ƒåŸç†å¾ˆç®€å•ï¼š**
1. **ç¼“å­˜æœºåˆ¶**ï¼šç”¨ `cache` å¯¹è±¡å­˜å‚¨å·²åŠ è½½çš„åº”ç”¨
2. **æ™ºèƒ½é¢„åŠ è½½**ï¼šé¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨é¢„åŠ è½½ï¼Œæ…¢ç½‘ç»œæ—¶è·³è¿‡
3. **ä¼˜å…ˆä½¿ç”¨ç¼“å­˜**ï¼šæ³¨å†Œåº”ç”¨æ—¶å…ˆæ£€æŸ¥ç¼“å­˜ï¼Œæœ‰å°±ç›´æ¥ç”¨
4. **ç”¨æˆ·ä½“éªŒ**ï¼šé¼ æ ‡æ‚¬åœæ—¶ä¹Ÿä¼šè§¦å‘é¢„åŠ è½½ï¼Œæå‰å‡†å¤‡

è¿™æ ·å®ç°çš„å¥½å¤„æ˜¯åº”ç”¨åˆ‡æ¢ä¼šéå¸¸å¿«ï¼Œå› ä¸ºå¤§éƒ¨åˆ†æƒ…å†µä¸‹åº”ç”¨å·²ç»é¢„åŠ è½½å¥½äº†ï¼

## èµ„æºå…±äº«

### Module Federation å…±äº«ä¾èµ–

```javascript
// Webpack Module Federation å…±äº«ä¾èµ–
module.exports = {
  plugins: [
    new ModuleFederationPlugin({
      name: 'host',
      shared: {
        react: {
          singleton: true,
          requiredVersion: '^17.0.0',
        },
        'react-dom': {
          singleton: true,
          requiredVersion: '^17.0.0',
        },
        'antd': {
          singleton: true,
          requiredVersion: '^4.0.0',
        },
      },
    }),
  ],
};

// å¤–éƒ¨ä¾èµ–å…±äº«
window.sharedDependencies = {
  react: React,
  'react-dom': ReactDOM,
  antd: antd,
  moment: moment,
};

// å­åº”ç”¨ä½¿ç”¨å…±äº«ä¾èµ–
const React = window.sharedDependencies?.react || require('react');
const ReactDOM = window.sharedDependencies?.['react-dom'] || require('react-dom');
```

## ç¼“å­˜ç­–ç•¥

```javascript
// åº”ç”¨ç¼“å­˜ç®¡ç†
class AppCache {
  constructor() {
    this.cache = new Map();
    this.maxSize = 10;
  }
  
  // ç¼“å­˜åº”ç”¨èµ„æº
  set(appName, resources) {
    if (this.cache.size >= this.maxSize) {
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
    
    this.cache.set(appName, {
      resources,
      timestamp: Date.now(),
    });
  }
  
  // è·å–ç¼“å­˜
  get(appName) {
    return this.cache.get(appName);
  }
  
  // æ¸…ç†è¿‡æœŸç¼“å­˜
  cleanup(maxAge = 30 * 60 * 1000) { // 30åˆ†é’Ÿ
    const now = Date.now();
    for (const [key, value] of this.cache.entries()) {
      if (now - value.timestamp > maxAge) {
        this.cache.delete(key);
      }
    }
  }
}

const appCache = new AppCache();
```

---

**å®Œæ•´æ€§èƒ½ä¼˜åŒ–å†…å®¹è¯·å‚è€ƒåŸæ–‡æ¡£**

**ä¸‹ä¸€æ­¥**ï¼šäº†è§£ [ç›‘æ§ä¸è°ƒè¯•](./07-ç›‘æ§ä¸è°ƒè¯•.md) çš„å®ç°æ–¹æ¡ˆ
